apiVersion: batch/v1
kind: Job
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"batch/v1","kind":"Job","metadata":{"annotations":{},"name":"test-db-connection","namespace":"bitpin-task"},"spec":{"template":{"spec":{"containers":[{"command":["/bin/bash","-c","echo \"Testing database connection...\"\n\n# تست اتصال ساده\nPGPASSWORD=\"jyoUv5DqaAyqFr4UTvakX6N5DcsCsiHDRqau0YH3cXjXD9pd4FL8lnMDltnaax9s\" psql \\\n  -h bitpin-cluster-rw.bitpin-task.svc.cluster.local \\\n  -U bitpin_user \\\n  -d bitpin_db \\\n  -c \"SELECT current_timestamp as time, current_database() as database, version();\"\n\necho \"✓ Database connection successful!\"\n\n# تست دایرکتوری بکاپ\necho \"Testing backup directory...\"\nBACKUP_DIR=\"/backups/full\"\nmkdir -p $BACKUP_DIR\ntouch \"$BACKUP_DIR/test-write-$(date +%Y%m%d-%H%M%S).txt\"\nls -la $BACKUP_DIR/\necho \"✓ Directory write test successful!\"\n"],"image":"postgres:15","name":"test-connection","volumeMounts":[{"mountPath":"/backups","name":"backup-storage"}]}],"nodeSelector":{"kubernetes.io/hostname":"mobin-log-backup-able"},"restartPolicy":"Never","volumes":[{"hostPath":{"path":"/mnt/backups","type":"Directory"},"name":"backup-storage"}]}}}}
  creationTimestamp: "2025-11-08T08:20:59Z"
  generation: 1
  labels:
    batch.kubernetes.io/controller-uid: 1c7c96b7-8f9c-4578-8451-0a02fedaee04
    batch.kubernetes.io/job-name: test-db-connection
    controller-uid: 1c7c96b7-8f9c-4578-8451-0a02fedaee04
    job-name: test-db-connection
  name: test-db-connection
  namespace: bitpin-task
  resourceVersion: "137384"
  uid: 1c7c96b7-8f9c-4578-8451-0a02fedaee04
spec:
  backoffLimit: 6
  completionMode: NonIndexed
  completions: 1
  manualSelector: false
  parallelism: 1
  podReplacementPolicy: TerminatingOrFailed
  selector:
    matchLabels:
      batch.kubernetes.io/controller-uid: 1c7c96b7-8f9c-4578-8451-0a02fedaee04
  suspend: false
  template:
    metadata:
      creationTimestamp: null
      labels:
        batch.kubernetes.io/controller-uid: 1c7c96b7-8f9c-4578-8451-0a02fedaee04
        batch.kubernetes.io/job-name: test-db-connection
        controller-uid: 1c7c96b7-8f9c-4578-8451-0a02fedaee04
        job-name: test-db-connection
    spec:
      containers:
      - command:
        - /bin/bash
        - -c
        - |
          echo "Testing database connection..."

          # تست اتصال ساده
          PGPASSWORD="jyoUv5DqaAyqFr4UTvakX6N5DcsCsiHDRqau0YH3cXjXD9pd4FL8lnMDltnaax9s" psql \
            -h bitpin-cluster-rw.bitpin-task.svc.cluster.local \
            -U bitpin_user \
            -d bitpin_db \
            -c "SELECT current_timestamp as time, current_database() as database, version();"

          echo "✓ Database connection successful!"

          # تست دایرکتوری بکاپ
          echo "Testing backup directory..."
          BACKUP_DIR="/backups/full"
          mkdir -p $BACKUP_DIR
          touch "$BACKUP_DIR/test-write-$(date +%Y%m%d-%H%M%S).txt"
          ls -la $BACKUP_DIR/
          echo "✓ Directory write test successful!"
        image: postgres:15
        imagePullPolicy: IfNotPresent
        name: test-connection
        resources: {}
        terminationMessagePath: /dev/termination-log
        terminationMessagePolicy: File
        volumeMounts:
        - mountPath: /backups
          name: backup-storage
      dnsPolicy: ClusterFirst
      nodeSelector:
        kubernetes.io/hostname: mobin-log-backup-able
      restartPolicy: Never
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      volumes:
      - hostPath:
          path: /mnt/backups
          type: Directory
        name: backup-storage
status:
  completionTime: "2025-11-08T08:21:03Z"
  conditions:
  - lastProbeTime: "2025-11-08T08:21:03Z"
    lastTransitionTime: "2025-11-08T08:21:03Z"
    message: Reached expected number of succeeded pods
    reason: CompletionsReached
    status: "True"
    type: SuccessCriteriaMet
  - lastProbeTime: "2025-11-08T08:21:03Z"
    lastTransitionTime: "2025-11-08T08:21:03Z"
    message: Reached expected number of succeeded pods
    reason: CompletionsReached
    status: "True"
    type: Complete
  ready: 0
  startTime: "2025-11-08T08:20:59Z"
  succeeded: 1
  terminating: 0
  uncountedTerminatedPods: {}
