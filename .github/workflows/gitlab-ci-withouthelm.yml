# .gitlab-ci.yml
stages:
  - lint
  - build
  - test
  - push
  - deploy

variables:
  # Set your defaults, override in CI variables if needed
  DOCKER_REGISTRY: "docker.io"
  IMAGE_NAME: "${IMAGE_NAME:-yasaman664/bitpin-task}"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  K8S_NAMESPACE: "${K8S_NAMESPACE:-bitpin-task}"
  DJANGO_SETTINGS_MODULE: "${DJANGO_SETTINGS_MODULE:-Exchange.settings}"
  # Short tag used for deployment
  IMAGE_TAG_SHORT: "$DOCKER_REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA"

# Cache pip between runs
cache:
  paths:
    - .cache/pip/

# ------------- LINT -------------
lint:
  stage: lint
  image: python:3.11-slim
  script:
    - pip install --upgrade pip
    - pip install flake8
    - flake8 Exchange || echo "flake8 returned non-zero (not failing CI by default)"
  artifacts:
    expire_in: 1h

# ------------- BUILD -------------
.build-template:
  image: docker:24.0.5
  services:
    - name: docker:24-dind
      alias: docker
  variables:
    DOCKER_TLS_CERTDIR: "/certs"
  before_script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin $DOCKER_REGISTRY

build:
  stage: build
  extends: .build-template
  script:
    - docker build --pull -t $IMAGE_TAG_SHORT -f Dockerfile .
    - echo "image=$IMAGE_TAG_SHORT" > image-info.txt
  artifacts:
    paths:
      - image-info.txt
    expire_in: 1h

# ------------- TEST -------------
test:
  stage: test
  image: python:3.11-slim
  dependencies:
    - build
  before_script:
    - pip install --upgrade pip
    - pip install --no-cache-dir -r requirement.txt
  script:
    - export DJANGO_SETTINGS_MODULE=$DJANGO_SETTINGS_MODULE
    # Try pytest if present, fall back to manage.py test
    - |
      if command -v pytest >/dev/null 2>&1; then
        pytest -q || pytest -q || true
      else
        python manage.py test --verbosity=2
      fi
  artifacts:
    when: always
    reports:
      junit: junit.xml || true
    expire_in: 1h

# ------------- PUSH -------------
push:
  stage: push
  extends: .build-template
  needs: ["build"]
  script:
    - docker tag $IMAGE_TAG_SHORT $DOCKER_REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker push $DOCKER_REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker tag $DOCKER_REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA $DOCKER_REGISTRY/$IMAGE_NAME:latest
    - docker push $DOCKER_REGISTRY/$IMAGE_NAME:latest
  only:
    - main
    - master

# ------------- DEPLOY -------------
deploy:
  stage: deploy
  image: bitnami/kubectl:1.27
  environment:
    name: production
    url: http://app.bitpin.local
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_DATA" | base64 -d > /tmp/kubeconfig
    - export KUBECONFIG=/tmp/kubeconfig
  script:
    - kubectl -n $K8S_NAMESPACE set image deployment/bitpin-task bitpin-task=$DOCKER_REGISTRY/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA || true
    - kubectl -n $K8S_NAMESPACE rollout status deployment/bitpin-task --timeout=5m
    - kubectl -n $K8S_NAMESPACE annotate deployment/bitpin-task ci.git_sha=$CI_COMMIT_SHA --overwrite || true
  only:
    - main
    - master
